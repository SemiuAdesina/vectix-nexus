import { writeFileSync, mkdirSync, existsSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";
import { Keypair } from "@solana/web3.js";
import { randomUUID } from "crypto";

const __dirname = dirname(fileURLToPath(import.meta.url));

const DEFAULT_PLUGINS = ["@elizaos/plugin-sql", "@elizaos/plugin-bootstrap"];
const DEFAULT_OUTPUT_DIR = "foundry-output";

function generateAgentConfig(options = {}) {
  const name = options.name || "Vectix Agent";
  const bio = options.bio || "Autonomous trading agent created by Vectix Foundry.";
  const system =
    options.system ||
    "You are a trading agent. Execute strategy within risk limits. Prefer clarity and consistency.";
  const config = {
    id: options.id || randomUUID(),
    name,
    bio: Array.isArray(bio) ? bio : [bio],
    system,
    plugins: options.plugins ?? DEFAULT_PLUGINS,
    topics: options.topics || ["trading", "solana", "defi"],
    adjectives: options.adjectives || ["analytical", "cautious", "systematic"],
    settings: options.settings || { source: "vectix-foundry" },
    style: { all: ["professional", "concise"] },
  };
  return config;
}

function generateWallet() {
  const keypair = Keypair.generate();
  const publicKey = keypair.publicKey.toBase58();
  const privateKey = Buffer.from(keypair.secretKey).toString("base64");
  return { publicKey, privateKey, keypair };
}

function writeDeploymentArtifacts(config, wallet, outputDir) {
  const base = join(process.cwd(), outputDir);
  if (!existsSync(base)) mkdirSync(base, { recursive: true });

  const configPath = join(base, "agent-config.json");
  writeFileSync(configPath, JSON.stringify(config, null, 2), "utf8");

  const envLines = [
    "# Generated by Vectix Foundry - add to eliza/.env or your runtime",
    `SOLANA_PUBLIC_KEY=${wallet.publicKey}`,
    `SOLANA_PRIVATE_KEY=${wallet.privateKey}`,
  ].join("\n");
  const envPath = join(base, "agent.env");
  writeFileSync(envPath, envLines + "\n", "utf8");

  return { configPath, envPath, config, wallet };
}

export function runFoundryDeploy(options = {}) {
  const outputDir = options.outputDir ?? DEFAULT_OUTPUT_DIR;
  const config = generateAgentConfig(options);
  const wallet = generateWallet();
  return writeDeploymentArtifacts(config, wallet, outputDir);
}

export { generateAgentConfig, generateWallet, writeDeploymentArtifacts, DEFAULT_OUTPUT_DIR };

function main() {
  console.log("Vectix Foundry â€” Deploy a New Agent");
  console.log("Generating agent config and wallet...\n");

  const { configPath, envPath, config, wallet } = runFoundryDeploy();

  console.log("Config written:", configPath);
  console.log("Env snippet written:", envPath);
  console.log("Agent name:", config.name);
  console.log("Wallet address:", wallet.publicKey);
  console.log("\nNext: Copy agent.env into eliza/.env, fund the wallet, then load agent-config.json into your runtime.");
}

const isEntry =
  typeof process !== "undefined" &&
  process.argv[1] &&
  process.argv[1].includes("foundry-deploy-agent.mjs");
if (isEntry) main();
