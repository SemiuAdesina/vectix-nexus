generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String             @id @default(cuid())
  email                 String             @unique
  name                  String?
  walletAddress         String?
  referralCode          String?            @unique
  referredById          String?
  referredBy            User?              @relation("Referrals", fields: [referredById], references: [id])
  referrals             User[]             @relation("Referrals")
  totalReferralEarnings Float              @default(0)
  turboModeEnabled      Boolean            @default(false)
  sanctionStatus        String             @default("clean")
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  subscriptions         Subscription[]
  agents                Agent[]
  createdStrategies     Strategy[]         @relation("StrategyAuthor")
  purchasedStrategies   StrategyPurchase[]
  referralPayouts       ReferralPayout[]
  apiKeys               ApiKey[]
  webhooks              Webhook[]
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                 String
  status               String
  stripePriceId        String?
  stripeSubscriptionId String?   @unique
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model Agent {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                 String
  characterConfig      String
  machineId            String?   @unique
  status               String    @default("stopped")
  walletAddress        String?
  encryptedSecrets     String?
  strategyId           String?
  strategy             Strategy? @relation(fields: [strategyId], references: [id])
  whitelistedWallet    String?
  whitelistLockedUntil DateTime?
  mevProtectionEnabled Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model Strategy {
  id            String             @id @default(cuid())
  name          String
  description   String
  priceUsd      Int                @default(0)
  configJson    String
  authorId      String
  author        User               @relation("StrategyAuthor", fields: [authorId], references: [id])
  category      String
  icon          String?
  featured      Boolean            @default(false)
  verified      Boolean            @default(false)
  purchaseCount Int                @default(0)
  agents        Agent[]
  purchases     StrategyPurchase[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

model StrategyPurchase {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyId      String
  strategy        Strategy @relation(fields: [strategyId], references: [id])
  pricePaid       Int
  stripePaymentId String?
  createdAt       DateTime @default(now())

  @@unique([userId, strategyId])
}

model ReferralPayout {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount       Float
  sourceUserId String
  sourceTxHash String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
}

model ApiKey {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  keyHash      String    @unique
  keyPrefix    String
  scopes       String
  tier         String    @default("free")
  requestCount Int       @default(0)
  lastUsedAt   DateTime?
  expiresAt    DateTime?
  revokedAt    DateTime?
  createdAt    DateTime  @default(now())
}

model Webhook {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  url       String
  events    String
  secret    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiRequestLog {
  id        String   @id @default(cuid())
  apiKeyId  String
  endpoint  String
  method    String
  status    Int
  createdAt DateTime @default(now())
}
